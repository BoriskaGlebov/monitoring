events {}

http {
    resolver 127.0.0.11 valid=10s;
    server {
        listen 80;
        server_name vpn-boriska.ru www.vpn-boriska.ru;

        # –î–ª—è Certbot (Let's Encrypt)
        location /.well-known/acme-challenge/ {
            root /var/www/certbot/;
            try_files $uri =404;
        }

        # –ê–≤—Ç–æ-—Ä–µ–¥–∏—Ä–µ–∫—Ç —Å HTTP –Ω–∞ HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name vpn-boriska.ru www.vpn-boriska.ru;

        # –ü—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º Let's Encrypt
        ssl_certificate /etc/letsencrypt/live/vpn-boriska.ru/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/vpn-boriska.ru/privkey.pem;
        ssl_dhparam /etc/ssl/certs/dhparam.pem;  # –ï—Å–ª–∏ –≤—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ DH-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSL
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:AES128-GCM-SHA256';
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 10m;

        # –ü—Ä–æ–∫—Å–∏ –¥–ª—è Prometheus
        location /prometheus/ {
            proxy_pass http://prometheus:9090;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            rewrite ^/prometheus(/.*)$ $1 break;  # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å /prometheus
        }



        # –î–ª—è Grafana
        location = /grafana {
            return 301 $scheme://$host/grafana/;
        }


        location /grafana/ {
            resolver 127.0.0.11;  # DNS-—Ä–µ–∑–æ–ª–≤–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            proxy_pass http://grafana:3000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            sub_filter '__grafanaRoot__/public/' '/grafana/public/';
            sub_filter '__grafanaRoot__' '/grafana';
            sub_filter_once off;
         }
#         location / {
#             resolver 127.0.0.11;
#             proxy_pass http://nginx_static:80/;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             # –í–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫
#             proxy_intercept_errors on;
#
#             # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ
#             error_page 502 =503 /maintenance.html;
#          }
        # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ kill_twitter
        location /maintenance.html {
            root /usr/share/nginx/html;
            internal;  # –ù–µ –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑–≤–Ω–µ
            }

        location /work_task/ {
            set $backend http://nginx_django:80;
            proxy_pass $backend;  # üëà —Ç–µ–ø–µ—Ä—å nginx –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ç —ç—Ç–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
            proxy_set_header X-Script-Name /work_task;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å /work_task, —á—Ç–æ–±—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π nginx –≤–∏–¥–µ–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å
            rewrite ^/work_task(/.*)$ $1 break;
            }


    }
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    include /etc/nginx/conf.d/*.conf;
}
